<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <link rel="shortcut icon" href="http://10.12.73.139:4000/wireless/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="../../../assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2724382-16"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-2724382-16'); </script> <script type="text/javascript" src="../../../assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="../../../assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>BLE+ZIGBEE Application | Microchip MPLAB Harmony Wireless help</title> <meta name="generator" content="Jekyll v3.9.0" /> <meta property="og:title" content="BLE+ZIGBEE Application" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Harmony 3 Wireless package" /> <meta property="og:description" content="Harmony 3 Wireless package" /> <link rel="canonical" href="readme.html" /> <meta property="og:url" content="http://10.12.73.139:4000/wireless/apps/multiprotocol/ble_zigbee_basic/readme.html" /> <meta property="og:site_name" content="Microchip MPLAB Harmony Wireless help" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="BLE+ZIGBEE Application" /> <script type="application/ld+json"> {"@type":"WebPage","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://10.12.73.139:4000/wireless/assets/images/vendor/microchip_mplab_harmony_logo_150_transparent.png"}},"url":"http://10.12.73.139:4000/wireless/apps/multiprotocol/ble_zigbee_basic/readme.html","headline":"BLE+ZIGBEE Application","description":"Harmony 3 Wireless package","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="../../../index.html" class="site-title lh-tight"> <div class="site-logo"></div> </a> <a href="readme.html#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="../../../index.html" class="nav-list-link">Harmony 3 Wireless Package</a></li><li class="nav-list-item active"><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../readme.html" class="nav-list-link">Examples applications</a><ul class="nav-list "><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../ble/building_blocks/readme.html" class="nav-list-link">BLE Building Blocks</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../ble/building_blocks/peripheral/readme.html" class="nav-list-link">Peripheral Building Blocks</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/central/scan_ext_adv/readme.html" class="nav-list-link">BLE Extended Scan</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/central/readme.html" class="nav-list-link">Central Building Blocks</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/central/connection/readme.html" class="nav-list-link">BLE Connection(Central)</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/central/profiles_services/readme.html" class="nav-list-link">BLE Profiles and Services (Central)</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/central/profiles_services/trp_uart/readme.html" class="nav-list-link">Central Transparent UART</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/central/profiles_services/ml_trp_uart/readme.html" class="nav-list-link">Multi Transparent UART</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/chip_peripherals/uart/readme.html" class="nav-list-link">UART Demo</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/central/freertos_ble_stack_init_central.html" class="nav-list-link">Freetos Stack Init</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/peripheral/legacy_adv_sleep/readme.html" class="nav-list-link">Legacy Advertisement</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/central/legacy_scan/readme.html" class="nav-list-link">Legacy Scan</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/peripheral/connection/readme.html" class="nav-list-link">Peripheral Connection</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/peripheral/ext_adv/readme.html" class="nav-list-link">Extended Advertisement</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/peripheral/profiles_services/readme.html" class="nav-list-link">Profile and Services</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/peripheral/profiles_services/trp_uart/readme.html" class="nav-list-link">Proprietary UART Service</a> </li><li class="nav-list-item "> <a href="../../ble/building_blocks/peripheral/profiles_services/custom_service/readme.html" class="nav-list-link">Custom Service</a> </li></ul></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../ble/advanced_applications/readme.html" class="nav-list-link">BLE Advance Applications</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../ble/advanced_applications/ble_uart_demo/readme.html" class="nav-list-link">BLE UART Demo</a> </li><li class="nav-list-item "> <a href="../../ble/advanced_applications/ble_sensor_app/readme.html" class="nav-list-link">BLE Sensor DEMO</a> </li><li class="nav-list-item "> <a href="../../ble/advanced_applications/ble_sensor_app/protocol.html" class="nav-list-link">BLE Sensor (Protocol Exchange)</a> </li></ul></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../zigbee/readme.html" class="nav-list-link">Zigbee</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../zigbee/zigbee_multisensor/readme.html" class="nav-list-link">Zigbee Multi-Sensor Low Power</a> </li><li class="nav-list-item "> <a href="../../zigbee/running_demo.html" class="nav-list-link">Zigbee Combined Interface Demo</a> </li><li class="nav-list-item "> <a href="../../zigbee/zigbee_commissioning.html" class="nav-list-link">Zigbee Commissioning Procedure</a> </li><li class="nav-list-item "> <a href="../../zigbee/zigbee_greenpower.html" class="nav-list-link">Zigbee Green Power</a> </li><li class="nav-list-item "> <a href="../../zigbee/zigbee_project_generation.html" class="nav-list-link">Zigbee Project Creation App</a> </li><li class="nav-list-item "> <a href="../../zigbee/zigbee_security_model.html" class="nav-list-link">Zigbee Network Security</a> </li></ul></li><li class="nav-list-item active"><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../readme.html" class="nav-list-link">Multiprotocol</a><ul class="nav-list"><li class="nav-list-item active"> <a href="readme.html" class="nav-list-link active">BLE+ZIGBEE Application</a> </li><li class="nav-list-item "> <a href="../ble_zigbee_light_prov/readme.html" class="nav-list-link">Multiprotocol Demo App</a> </li><li class="nav-list-item "> <a href="../ble_zigbee_multiSensor_prov/readme.html" class="nav-list-link">Zigbee Multi-Sensor, commissioning App</a> </li><li class="nav-list-item "> <a href="../ble_zigbee_light_prov/protocol.html" class="nav-list-link">Multiprotocol Protocol</a> </li></ul></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../docs/readme.html" class="nav-list-link">User Docs</a><ul class="nav-list"><li class="nav-list-item "> <a href="../../zigbee/consoleCommands.html" class="nav-list-link">Serial Console Commands</a> </li><li class="nav-list-item "> <a href="../../docs/lowpower.html" class="nav-list-link">Low Power</a> </li><li class="nav-list-item "> <a href="../../docs/user_action.html" class="nav-list-link">User Action</a> </li><li class="nav-list-item "> <a href="../../docs/generate_code.html" class="nav-list-link">Harmony 3 Code Generation</a> </li><li class="nav-list-item "> <a href="../../docs/creating_new_mplabx_harmony_project.html" class="nav-list-link">Generating New Harmony Code</a> </li><li class="nav-list-item "> <a href="../../docs/pic32cx_bz2_wbz45x_sdk_setup.html" class="nav-list-link">SDK Setup</a> </li></ul></li></ul></li><li class="nav-list-item"><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../../release_notes.html" class="nav-list-link">Release notes</a><ul class="nav-list "><li class="nav-list-item "><a href="../../ble/advanced_applications/ble_uart_demo/release_notes.html" class="nav-list-link">BLE UART Demo</a></li><li class="nav-list-item "><a href="../../ble/advanced_applications/ble_sensor_app/release_notes.html" class="nav-list-link">BLE Sensor Release notes</a></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../ble/building_blocks/chip_peripherals/uart/release_notes.html" class="nav-list-link">UART Hello World</a><ul class="nav-list"></ul></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../ble/building_blocks/peripheral/legacy_adv_sleep/release_notes.html" class="nav-list-link">BLE Legacy Adv</a><ul class="nav-list"></ul></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../ble/building_blocks/peripheral/ext_adv/release_notes.html" class="nav-list-link">BLE Extended Advertising</a><ul class="nav-list"></ul></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../ble/building_blocks/peripheral/connection/release_notes.html" class="nav-list-link">BLE Connection (Peripheral)</a><ul class="nav-list"></ul></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../ble/building_blocks/peripheral/profiles_services/custom_service/release_notes.html" class="nav-list-link">BLE Tranparent UART (Peirpheral)</a><ul class="nav-list"></ul></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../ble/building_blocks/peripheral/profiles_services/trp_uart/release_notes.html" class="nav-list-link">BLE Tranparent UART (Peirpheral)</a><ul class="nav-list"></ul></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../ble/building_blocks/central/connection/release_notes.html" class="nav-list-link">BLE Connection (Central)</a><ul class="nav-list"></ul></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../ble/building_blocks/central/legacy_scan/release_notes.html" class="nav-list-link">BLE Legacy Scan</a><ul class="nav-list"></ul></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../ble/building_blocks/central/profiles_services/ml_trp_uart/release_notes.html" class="nav-list-link">BLE Multilink Transparent UART(Central)</a><ul class="nav-list"></ul></li><li class="nav-list-item "><a href="readme.html#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="../../ble/building_blocks/central/profiles_services/trp_uart/release_notes.html" class="nav-list-link">BLE Transparent UART(Central)</a><ul class="nav-list"></ul></li><li class="nav-list-item "><a href="../../ble/building_blocks/central/scan_ext_adv/release_notes.html" class="nav-list-link">BLE Scan Extended Advertising</a></li><li class="nav-list-item "><a href="../../zigbee/zigbee_combined_interface/release_notes.html" class="nav-list-link">Zigbee Combined Interface App</a></li><li class="nav-list-item "><a href="../../zigbee/zigbee_lights/release_notes.html" class="nav-list-link">Zigbee Extended Lights App</a></li><li class="nav-list-item "><a href="../../zigbee/zigbee_multisensor/release_notes.html" class="nav-list-link">Zigbee Multi-Sensor Device Low Power</a></li><li class="nav-list-item "><a href="../ble_zigbee_light_prov/release_notes.html" class="nav-list-link">Zigbee Multiprotocol Lights Prov App</a></li><li class="nav-list-item "><a href="../ble_zigbee_multiSensor_prov/release_notes.html" class="nav-list-link">Zigbee Multi-Sensor and commissioning</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Microchip MPLAB Harmony Wireless help" aria-label="Search Microchip MPLAB Harmony Wireless help" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="https://support.microchip.com" class="site-button" > Obtain Support from Microchip </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="../../readme.html">Examples applications</a></li> <li class="breadcrumb-nav-list-item"><a href="../readme.html">Multiprotocol</a></li> <li class="breadcrumb-nav-list-item"><span>BLE+ZIGBEE Application</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <p><a href="https://www.microchip.com"><img src="https://www.microchip.com/ResourcePackages/Microchip/assets/dist/images/logo.png" alt="MCHP" /></a></p> <h1 id="multiprotocol-blezigbee-concurrent-application---tutorial"> <a href="readme.html#multiprotocol-blezigbee-concurrent-application---tutorial" aria-labelledby="multiprotocol-blezigbee-concurrent-application---tutorial" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Multiprotocol (BLE+ZIGBEE) Concurrent Application - Tutorial </h1> <p>This tutorial will help users to create multiprotocol (BLE+ZIGBEE) example project from Microchip H3 project generator framework. The step by step procedure will help the user to generate the multiprotocol project from scratch and will guide in understanding few API calls needed for data transaction between 2 protocols.</p> <p>The project created at end of this tutorial, will look the sample project available <a href="firmware/index.html"> here </a>.</p> <h2 id="hardware-required"> <a href="readme.html#hardware-required" aria-labelledby="hardware-required" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Hardware Required </h2> <div class="table-wrapper"><table> <thead> <tr> <th><strong>Tool</strong></th> <th><strong>Qty</strong></th> </tr> </thead> <tbody> <tr> <td>WBZ451 Curiosity Board</td> <td>2</td> </tr> <tr> <td>Micro USB cable</td> <td>2</td> </tr> <tr> <td>Android/iOS Mobile</td> <td>1</td> </tr> </tbody> </table></div> <h2 id="sdk-setup"> <a href="readme.html#sdk-setup" aria-labelledby="sdk-setup" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> SDK Setup </h2> <p><a href="../../docs/pic32cx_bz2_wbz45x_sdk_setup.html">SDK Setup</a></p> <h2 id="software"> <a href="readme.html#software" aria-labelledby="software" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Software </h2> <p><a href="https://ttssh2.osdn.jp/index.html.en">TeraTerm</a></p> <h2 id="smartphone-app"> <a href="readme.html#smartphone-app" aria-labelledby="smartphone-app" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Smartphone App </h2> <p>Microchip Bluetooth Data (MBD) iOS/Android app available in stores</p> <h2 id="demo-description"> <a href="readme.html#demo-description" aria-labelledby="demo-description" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Demo Description </h2> <p>This application demonstrate the Zigbee On/Off light joining to Zigbee gateway (Combined Interface) and the Microchip Proprietary Transparent Service based BLE peripheral running concurrently with zigbee protocol connects with mobile app. When the Zigbee light gets the light on/off command from CI will be displayed in mobile app. Hence the simple concurrent operation of multiprotocol is demonstrated here. Lights and Bridge (CI) devices are the interest of this tutorial, where the WIFI/Ethernet gateway is not scope of this application. The thirdparty gateway’s like Amazon Echo plus can also be used instead of CI.</p> <p><img src="assets/block_dia.png" alt="" /></p> <hr /> <h2 id="developing-this-application-from-scratch-using-harmony-3"> <a href="readme.html#developing-this-application-from-scratch-using-harmony-3" aria-labelledby="developing-this-application-from-scratch-using-harmony-3" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Developing this Application from scratch using Harmony 3 </h2> <p>The following steps will help to understand the PIC32CXBZ2 device ZIGBEE and BLE stack programming structure. We recommend to follow the steps. If wish to have Out-of-Box experience with the precompiled hex file <a href="readme.html#tasks_1">Go Here</a></p> <h2 id="pull-in-h3-components"> <a href="readme.html#pull-in-h3-components" aria-labelledby="pull-in-h3-components" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Pull-in H3 Components </h2> <ol> <li> <p>Create a new MPLAB Harmony 3 Project – <a href="../../docs/creating_new_mplabx_harmony_project.html">link</a> for instructions</p> </li> <li> <p>Drag and Drop the Zigbee components from “Available” components to Project Graph</p> <ul> <li>OnOffLight Device component</li> </ul> <p>“Accept Dependencies or satisfiers, select “Yes””</p> </li> </ol> <div style="text-align:center"><img src="assets/H3_1.png" /></div> <div style="text-align:center"><img src="assets/H3_2.png" /></div> <ol> <li>Drag and Drop the BLE components <ul> <li>BLE Stack component</li> </ul> </li> </ol> <div style="text-align:center"><img src="assets/H3_3_1.png" /></div> <p>&lt;/br&gt;</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Transparent Profile and Service components

 "Add  Dependencies or satisfiers"
</code></pre></div></div> <div style="text-align:center"><img src="assets/H3_4.png" /></div> <ol> <li>Add UART components needed for console logs</li> </ol> <div style="text-align:center"><img src="assets/H3_5.png" /></div> <ol> <li>Verify if the Project Graph window has all the expected Harmony 3 configuration</li> </ol> <div style="text-align:center"><img src="assets/H3.png" /></div> <hr /> <h2 id="edit-ble-stack-specific-configurations"> <a href="readme.html#edit-ble-stack-specific-configurations" aria-labelledby="edit-ble-stack-specific-configurations" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Edit BLE Stack Specific Configurations </h2> <p><a name="tasks"> </a></p> <ol> <li>Select <strong>BLE_Stack</strong> component in project graph and edit as below</li> </ol> <div style="text-align:center"><img src="assets/BLE_1.png" /></div> <ol> <li>Select <strong>Transparent Profile</strong> component in project graph and edit as below.</li> </ol> <div style="text-align:center"><img src="assets/BLE_2_1.png" /></div> <h2 id="edit-zigbee-stack-specific-configurations"> <a href="readme.html#edit-zigbee-stack-specific-configurations" aria-labelledby="edit-zigbee-stack-specific-configurations" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Edit Zigbee Stack Specific Configurations </h2> <ol> <li>Edit <strong>Onoff Light</strong> component in project graph. The “Commissioning Configuration” is edited to enable only Steering option</li> </ol> <div style="text-align:center"><img src="assets/Zigbee_1.png" /></div> <h2 id="edit-peripheral-specific-configurations"> <a href="readme.html#edit-peripheral-specific-configurations" aria-labelledby="edit-peripheral-specific-configurations" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Edit Peripheral Specific Configurations </h2> <ol> <li>Edit <strong>SERCOM0</strong> component in project graph for UART pin map and Baud rate</li> </ol> <div style="text-align:center"><img src="assets/zigbee_2.png" /></div> <ol> <li>Edit <strong>Pin Configuration</strong> in project graph for RED LED GPIO configuration</li> </ol> <div style="text-align:center"><img src="assets/peripheral_1.png" /></div> <hr /> <h2 id="generate-code-link-for-instructions"> <a href="readme.html#generate-code-link-for-instructions" aria-labelledby="generate-code-link-for-instructions" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Generate Code <a href="../../docs/generate_code.html">link</a> for instructions </h2> <hr /> <h2 id="files-and-routines-automatically-generated-by-the-mhc"> <a href="readme.html#files-and-routines-automatically-generated-by-the-mhc" aria-labelledby="files-and-routines-automatically-generated-by-the-mhc" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Files and Routines Automatically generated by the MHC </h2> <p>After generating the code from MHC interface by clicking Generate Code, below is the project folder structure.</p> <div style="text-align:center"><img src="assets/code_2.png" /></div> <ol> <li>BLE, Zigbee Stack Initialization and Application callback registration:</li> </ol> <p>The RF System, BLE System, ZIGBEE, PERIPHERAL initialization routine executed during program initialization can be found in <strong>SYS_Initialize()</strong> of <strong>initialization.c</strong> file</p> <p>Zigbee Stack provides various APIs for application, and those APIs belong to the specific module within dedicated group. The sequence of initialization is already taken care in the stack when <strong>Zigbee_Init()</strong> from <strong>initialization.c</strong> is called.</p> <div style="text-align:center"><img src="assets/code_1.png" /></div> <p>The BLE stack initialization routine executed during Application Initialization can be found in <strong>APP_BleStackInit()</strong> in <strong>app.c</strong>. This call initializes and configures different BLE layers like GAP, GATT, SMP, L2CAP and BLE middleware layers and registers the application layer callbacks. The event callbacks from BLE stack, BLE middleware and Profile/service layer are registered.</p> <p>Also, the H3 configured advertisement data payload can be seen in <strong>APP_BleConfig()</strong></p> <div style="text-align:center"><img src="assets/trp_uart.png" /></div> <p>Similar to BLE, Zigbee Stack also generate events to inform application if there is any status changed or activity. Application may need to get the relevant information from Zigbee Stack and do the corresponding procedure.</p> <div style="text-align:center"><img src="assets/code_3.png" /></div> <ol> <li>BLE, Zigbee Stack application events handling: <strong>app.c</strong> file is autogenerated and has a state machine for application callback handling from BLE, Zigbee stacks</li> </ol> <div style="text-align:center"><img src="assets/code_4.png" /></div> <hr /> <h2 id="user-application-development"> <a href="readme.html#user-application-development" aria-labelledby="user-application-development" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> User Application Development </h2> <h3 id="1-compile-h3-auto-generated-project"> <a href="readme.html#1-compile-h3-auto-generated-project" aria-labelledby="1-compile-h3-auto-generated-project" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Compile H3 auto generated project </h3> <ol> <li>Compile the H3 auto generated project as below</li> </ol> <p><img src="assets/build.png" alt="" /></p> <div style="text-align:center"><img src="assets/error.png" /></div> <ol> <li>Addressing the mandatory error: User action required in app_idle_task.c. Follow the steps mentioned in the note and do the necessary changes. Then comment the <strong>#error</strong> message as below.</li> </ol> <div style="text-align:center"><img src="assets/error1.png" /></div> <h3 id="2-ble-specific-code-addition"> <a href="readme.html#2-ble-specific-code-addition" aria-labelledby="2-ble-specific-code-addition" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. BLE specific code addition </h3> <h4 id="1-start-advertisement-appc"> <a href="readme.html#1-start-advertisement-appc" aria-labelledby="1-start-advertisement-appc" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Start Advertisement (app.c) </h4> <p>Advertisement payload is already auto generated based on H3 configuration as mentioned in <a href="readme.html#tasks">Edit BLE Stack Specific Configurations</a>. It is only required to start the advertisement, by adding the below API in APP_STATE_INIT state.</p> <ul> <li>BLE_GAP_SetAdvEnable(true, 0);</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">void</span><span class="w"> </span><span class="err">APP_Tasks</span><span class="w"> </span><span class="err">(</span><span class="w"> </span><span class="err">void</span><span class="w"> </span><span class="err">)</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="err">APP_Msg_T</span><span class="w">    </span><span class="err">appMsg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="err">;</span><span class="w">
    </span><span class="err">APP_Msg_T</span><span class="w">   </span><span class="err">*p_appMsg;</span><span class="w">
    </span><span class="err">p_appMsg=appMsg;</span><span class="w">

    </span><span class="err">ZB_AppGenericCallbackParam_t</span><span class="w"> </span><span class="err">cb;</span><span class="w">
    </span><span class="err">/*</span><span class="w"> </span><span class="err">Check</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">application's</span><span class="w"> </span><span class="err">current</span><span class="w"> </span><span class="err">state.</span><span class="w"> </span><span class="err">*/</span><span class="w">
    </span><span class="err">switch</span><span class="w"> </span><span class="err">(</span><span class="w"> </span><span class="err">appData.state</span><span class="w"> </span><span class="err">)</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="err">/*</span><span class="w"> </span><span class="err">Application's</span><span class="w"> </span><span class="err">initial</span><span class="w"> </span><span class="err">state.</span><span class="w"> </span><span class="err">*/</span><span class="w">
        </span><span class="err">case</span><span class="w"> </span><span class="err">APP_STATE_INIT:</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="err">bool</span><span class="w"> </span><span class="err">appInitialized</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="kc">true</span><span class="err">;</span><span class="w">
            </span><span class="err">//appData.appQueue</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">xQueueCreate(</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="err">sizeof(APP_Msg_T)</span><span class="w"> </span><span class="err">);</span><span class="w">
            </span><span class="err">APP_BleStackInit();</span><span class="w">
            </span><span class="err">BLE_GAP_SetAdvEnable(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="err">);</span><span class="w">
</span></code></pre></div></div> <h4 id="2-connected--disconnected-events-app_ble_handlerc"> <a href="readme.html#2-connected--disconnected-events-app_ble_handlerc" aria-labelledby="2-connected--disconnected-events-app_ble_handlerc" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Connected &amp; Disconnected Events (app_ble_handler.c) </h4> <p>The BLE application specific callbacks from BLE stack is handled in <strong>app_ble_handler.c</strong> file. Few events needed for this application to be handled by the user code as below.</p> <h5 id="connection-handler"> <a href="readme.html#connection-handler" aria-labelledby="connection-handler" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Connection Handler </h5> <ul> <li>In <strong>app_ble_handler.c</strong>, BLE_GAP_EVT_CONNECTED event will be generated when a BLE peripheral is connected with Central (mobile app)</li> <li>Connection handle associated with the peer central device needs to be saved for data exchange after a BLE connection. Add the below code in <strong>APP_BleGapEvtHandler()</strong>.</li> <li>Console log is also added to print the connected message and respective #include file is also added.</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#include</span><span class="w"> </span><span class="err">&lt;app_zigbee/zigbee_console/console.h&gt;</span><span class="w">

</span><span class="err">void</span><span class="w"> </span><span class="err">APP_BleGapEvtHandler(BLE_GAP_Event_T</span><span class="w"> </span><span class="err">*p_event)</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="err">switch(p_event-&gt;eventId)</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="err">case</span><span class="w"> </span><span class="err">BLE_GAP_EVT_CONNECTED:</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="err">/*</span><span class="w"> </span><span class="err">TODO:</span><span class="w"> </span><span class="err">implement</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">application</span><span class="w"> </span><span class="err">code.*/</span><span class="w">
            </span><span class="err">appSnprintf(</span><span class="s2">"[BLE} Connected</span><span class="se">\n\r</span><span class="s2">"</span><span class="err">);</span><span class="w">
            </span><span class="err">conn_hdl</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">p_event-&gt;eventField.evtConnect.connHandle;</span><span class="w">
            </span><span class="err">linkState</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">APP_BLE_STATE_CONNECTED;</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="err">break;</span><span class="w">
</span></code></pre></div></div> <ul> <li>In <strong>app_ble_handler.h</strong> add the below definitions which are used in above step</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">//</span><span class="w"> </span><span class="err">*****************************************************************************</span><span class="w">
</span><span class="err">//</span><span class="w"> </span><span class="err">*****************************************************************************</span><span class="w">
</span><span class="err">//</span><span class="w"> </span><span class="err">Section:</span><span class="w"> </span><span class="err">Type</span><span class="w"> </span><span class="err">Definitions</span><span class="w">
</span><span class="err">//</span><span class="w"> </span><span class="err">*****************************************************************************</span><span class="w">
</span><span class="err">//</span><span class="w"> </span><span class="err">*****************************************************************************</span><span class="w">
</span><span class="err">uint</span><span class="mi">16</span><span class="err">_t</span><span class="w"> </span><span class="err">conn_hdl;</span><span class="w">
</span><span class="err">uint</span><span class="mi">8</span><span class="err">_t</span><span class="w"> </span><span class="err">linkState;</span><span class="w">

</span><span class="err">#define</span><span class="w"> </span><span class="err">APP_BLE_STATE_CONNECTED</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">01</span><span class="w">
</span><span class="err">#define</span><span class="w"> </span><span class="err">APP_BLE_STATE_STANDBY</span><span class="w">  </span><span class="mi">0</span><span class="err">x</span><span class="mi">00</span><span class="w">
</span></code></pre></div></div> <h5 id="disconnection-handler"> <a href="readme.html#disconnection-handler" aria-labelledby="disconnection-handler" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Disconnection Handler </h5> <ul> <li>In <strong>app_ble_handler.c</strong>, BLE_GAP_EVT_DISCONNECTED event will be generated when BLE peripheral is disconnected from Central (mobile app)</li> <li>Advertisement can be started again to enable another connection</li> <li>Console log is also added to print the disconnected message</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">case</span><span class="w"> </span><span class="err">BLE_GAP_EVT_DISCONNECTED:</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="err">/*</span><span class="w"> </span><span class="err">TODO:</span><span class="w"> </span><span class="err">implement</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">application</span><span class="w"> </span><span class="err">code.*/</span><span class="w">
    </span><span class="err">appSnprintf(</span><span class="s2">"[BLE} DisConnected</span><span class="se">\n\r</span><span class="s2">"</span><span class="err">);</span><span class="w">
    </span><span class="err">BLE_GAP_SetAdvEnable(</span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="err">);</span><span class="w">
    </span><span class="err">linkState</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">APP_BLE_STATE_STANDBY;</span><span class="w">               
</span><span class="p">}</span><span class="w">
</span><span class="err">break;</span><span class="w">
</span></code></pre></div></div> <h3 id="3-zigbee-specific-code-addition-app_zigbee_handlerc"> <a href="readme.html#3-zigbee-specific-code-addition-app_zigbee_handlerc" aria-labelledby="3-zigbee-specific-code-addition-app_zigbee_handlerc" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Zigbee specific code addition (app_zigbee_handler.c) </h3> <p>There will be 3 major events which the stack would provide to the user application in <strong>app_zigbee_handler.c</strong> file. They are ,</p> <ul> <li>Zigbee Events which is defined as “EVENT_ZIGBEE”</li> <li>ZCL and Cluster Events defined as “EVENT_CLUSTER”</li> <li>Board Specific Package (BSP) Events defined as “EVENT_BSP”</li> </ul> <h4 id="1-zcl-event_cluster-event-handling-for-onoff-light-cluster"> <a href="readme.html#1-zcl-event_cluster-event-handling-for-onoff-light-cluster" aria-labelledby="1-zcl-event_cluster-event-handling-for-onoff-light-cluster" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. ZCL EVENT_CLUSTER event handling for on/off Light cluster </h4> <p><strong>ZCL (Zigbee cluster library)</strong></p> <ul> <li>ZCL is a repository for cluster functionalities</li> <li>Regularly updated with new functionality added</li> <li>Not to “re-invent the wheel” for new application development</li> </ul> <p><strong>Cluster</strong></p> <ul> <li>Cluster is a set of attributes and commands which are defined for a particular application functionality/feature.</li> <li>Attributes and their data types are defined</li> <li>Uses client/server model of communication</li> <li>Standard commands/messages ensure interoperability, abstracts the commands for developers.</li> </ul> <p><strong>Ex: On/Off cluster</strong> Attributes: OnOff, OnTime, OffWaitTime Commands: Off, On, Toggle, OffWithEffect, OnWithRecallGlobalScene, OnWithTimedOff</p> <p>&lt;/br&gt; <span class="icon icon-search inline-block highlight-info"> <i>-Explore</i></span> &lt;/br&gt;</p> <p>For more details regarding clusters, please refer to, the specification from Zigbee Alliance -&gt; <a href="https://zigbeealliance.org/wp-content/uploads/2019/12/07-5123-06-zigbee-cluster-library-specification.pdf" target="_top">Link to Zigbee Cluster Library Specification by Zigbee Alliance</a></p> <p>This project uses On/Off device type. Hence uses <strong>On/Off light cluster</strong> from Zigbee defined cluster library. When the On/Off command to control the light is received from Combined Interface gateway, CMD_ZCL_ON, CMD_ZCL_OFF of ZCL EVENT_CLUSTER will be received on light device. A simple console print is already added in those event callbacks as below.</p> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">void</span><span class="w"> </span><span class="err">Cluster_Event_Handler(APP_Zigbee_Event_t</span><span class="w"> </span><span class="err">event)</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="err">switch(event.eventId)</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="err">case</span><span class="w"> </span><span class="err">CMD_ZCL_ON:</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="err">/*</span><span class="w"> </span><span class="err">ZCL</span><span class="w"> </span><span class="err">Command</span><span class="w"> </span><span class="err">ON</span><span class="w"> </span><span class="err">received</span><span class="w"> </span><span class="err">*/</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.zclEventData.addressing;</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.zclEventData.payloadLength;</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.zclEventData.payload;</span><span class="w">
            </span><span class="err">appSnprintf(</span><span class="s2">"On</span><span class="se">\r\n</span><span class="s2">"</span><span class="err">);</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="err">break;</span><span class="w">
        </span><span class="err">case</span><span class="w"> </span><span class="err">CMD_ZCL_OFF:</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="err">/*</span><span class="w"> </span><span class="err">ZCL</span><span class="w"> </span><span class="err">Command</span><span class="w"> </span><span class="err">Off</span><span class="w"> </span><span class="err">received</span><span class="w"> </span><span class="err">*/</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.zclEventData.addressing;</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.zclEventData.payloadLength;</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.zclEventData.payload;</span><span class="w">
            </span><span class="err">appSnprintf(</span><span class="s2">"Off</span><span class="se">\r\n</span><span class="s2">"</span><span class="err">);</span><span class="w">
        </span><span class="p">}</span><span class="w">
        </span><span class="err">break;</span><span class="w">
</span></code></pre></div></div> <h4 id="2-event_bsp-event-handling-for-onoff-light-control"> <a href="readme.html#2-event_bsp-event-handling-for-onoff-light-control" aria-labelledby="2-event_bsp-event-handling-for-onoff-light-control" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. EVENT_BSP event handling for on/off Light control </h4> <ul> <li>In addition to above ZCL event, BSP event will also be called when On/Off command is received. This will enable the user to write the board specific functionality code like switch on/off the on board LED. <strong>CMD_LED_BRIGHTNESS</strong> single event is called for both On or Off, since On/Off cluster is added in many other device types like dimmable light, color control light, where light functionality is also mapped to brightness/color and not simple On/Off. Add below code to control on board <strong>RED</strong> LED.</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">void</span><span class="w"> </span><span class="err">BSP_Event_Handler(APP_Zigbee_Event_t</span><span class="w"> </span><span class="err">event)</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="err">//</span><span class="w"> </span><span class="err">User</span><span class="w"> </span><span class="err">to</span><span class="w"> </span><span class="err">handle</span><span class="w">  </span><span class="err">board</span><span class="w"> </span><span class="err">Support</span><span class="w"> </span><span class="err">package</span><span class="w"> </span><span class="err">events</span><span class="w">
    </span><span class="err">switch(event.eventId)</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="err">case</span><span class="w"> </span><span class="err">CMD_LED_BRIGHTNESS:</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="err">/*</span><span class="w"> </span><span class="err">Set</span><span class="w"> </span><span class="err">the</span><span class="w"> </span><span class="err">given</span><span class="w"> </span><span class="err">LED</span><span class="w"> </span><span class="err">brightness</span><span class="w"> </span><span class="err">*/</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.value;</span><span class="w">
            </span><span class="err">//appSnprintf(</span><span class="s2">"Led Brightness </span><span class="se">\r\n</span><span class="s2">"</span><span class="err">);</span><span class="w">
            </span><span class="err">if(event.eventData.value</span><span class="w"> </span><span class="err">==</span><span class="w"> </span><span class="mi">255</span><span class="err">)//</span><span class="w"> </span><span class="err">MAX_BRIGHTNESS_LEVEL</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">On</span><span class="w">
               </span><span class="err">RED_LED_Set();</span><span class="w">
            </span><span class="err">else</span><span class="w"> </span><span class="err">if</span><span class="w"> </span><span class="err">(event.eventData.value</span><span class="w"> </span><span class="err">==</span><span class="w"> </span><span class="mi">0</span><span class="err">)</span><span class="w"> </span><span class="err">//MIN_BRIGHTNESS_LEVEL</span><span class="w"> </span><span class="err">for</span><span class="w"> </span><span class="err">Off</span><span class="w">
               </span><span class="err">RED_LED_Clear();</span><span class="w">

        </span><span class="p">}</span><span class="w">
        </span><span class="err">break;</span><span class="w">
</span></code></pre></div></div> <ul> <li>Add the include file needed for LED GPIO functionality in <strong>app_zigbee_handler.c</strong></li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#include</span><span class="w"> </span><span class="s2">"peripheral/gpio/plib_gpio.h"</span><span class="w">
</span></code></pre></div></div> <h4 id="3-edit-device-unique-id-zigbeeappdeviceselecth"> <a href="readme.html#3-edit-device-unique-id-zigbeeappdeviceselecth" aria-labelledby="3-edit-device-unique-id-zigbeeappdeviceselecth" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 3. Edit device unique ID (zigbeeAppDeviceSelect.h) </h4> <p>All the zigbee devices/modules will hold their unique IEEE address purchased from IEEE. For the demo purpose, where UID is not present in internal NVM, the pre-compiled fixed UID to be used. Edit the CS_UID to user defined value and not matching with combined interface UID (default 0xbee) as below in <strong>zigbeeAppDeviceSelect.h</strong></p> <p align="left"> <img src="assets/uid.png" width="500" height="500" /> </p> <h3 id="4-data-transaction-between-ble-to-zigbee-protocol-and-vice-versa"> <a href="readme.html#4-data-transaction-between-ble-to-zigbee-protocol-and-vice-versa" aria-labelledby="4-data-transaction-between-ble-to-zigbee-protocol-and-vice-versa" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 4. Data Transaction between BLE to ZIGBEE protocol and vice versa </h3> <p>Transparent Profile and Service (TRP/TRS) is the proprietary BLE service by microchip to establish data and control channel between BLE Central (Phone) and Peripheral (device). The custom 128-bit GATT characteristics are defined under this service.</p> <p><strong>Definition of Transparent Service and Characteristics UUID’s</strong></p> <div class="table-wrapper"><table> <thead> <tr> <th style="text-align: left">Characteristic Name</th> <th style="text-align: center">UUID</th> <th style="text-align: right">Properties</th> <th> </th> </tr> </thead> <tbody> <tr> <td style="text-align: left">TRS Service</td> <td style="text-align: center">49535343-FE7D-4AE5-8FA9-9FAFD205E455</td> <td style="text-align: right"> </td> <td> </td> </tr> <tr> <td style="text-align: left">TRS TxD- Tx Data to Client role (Data pipe)</td> <td style="text-align: center">49535343-1E4D-4BD9-BA61-23C647249616</td> <td style="text-align: right">Notify, Write</td> <td> </td> </tr> <tr> <td style="text-align: left">TRS TxD - Client Characteristic Configuration Descriptor</td> <td style="text-align: center"> </td> <td style="text-align: right">Read, Write</td> <td> </td> </tr> <tr> <td style="text-align: left">TRS RxD- Rx Data from Client role (Data pipe)</td> <td style="text-align: center">49535343-8841-43F4-A8D4-ECBE34729BB3</td> <td style="text-align: right">Write, Write without response</td> <td> </td> </tr> <tr> <td style="text-align: left">TRS Ctrl Pt - Command and Response (Ctrl pipe)</td> <td style="text-align: center">49535343-4C8A-39B3-2F49-511CFF073B7E</td> <td style="text-align: right">Notify, Write, Write without response</td> <td> </td> </tr> <tr> <td style="text-align: left">TRS Ctrl Pt - Client Characteristic Configuration descriptor</td> <td style="text-align: center"> </td> <td style="text-align: right">Read, Write</td> <td>{:.table-striped}</td> </tr> </tbody> </table></div> <h4 id="1-send-data-over-ble-app_zigbee_handlerc"> <a href="readme.html#1-send-data-over-ble-app_zigbee_handlerc" aria-labelledby="1-send-data-over-ble-app_zigbee_handlerc" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 1. Send data over BLE (app_zigbee_handler.c) </h4> <p>When the On/Off command is received from CI, send single byte of data to mobile app using Transparent service. We use TRS Ctrl Pt characteristic in this example project to send and receive data from mobile app.</p> <ul> <li><strong>BLE_TRSPS_SendVendorCommand(conn_hdl, 0x8F, 0x01, &amp;onCmd)</strong> is the API to be used for sending data towards the central device. Here 0x8F is any custom command value for identification and 0x01 is length of the command data. Add this API call in Zigbee On/Off ZCL event callbacks as below.</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">void</span><span class="w"> </span><span class="err">Cluster_Event_Handler(APP_Zigbee_Event_t</span><span class="w"> </span><span class="err">event)</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="err">switch(event.eventId)</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="err">case</span><span class="w"> </span><span class="err">CMD_ZCL_ON:</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="err">/*</span><span class="w"> </span><span class="err">ZCL</span><span class="w"> </span><span class="err">Command</span><span class="w"> </span><span class="err">ON</span><span class="w"> </span><span class="err">received</span><span class="w"> </span><span class="err">*/</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.zclEventData.addressing;</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.zclEventData.payloadLength;</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.zclEventData.payload;</span><span class="w">
            </span><span class="err">appSnprintf(</span><span class="s2">"On</span><span class="se">\r\n</span><span class="s2">"</span><span class="err">);</span><span class="w">
            </span><span class="err">uint</span><span class="mi">8</span><span class="err">_t</span><span class="w"> </span><span class="err">onCmd;</span><span class="w">
            </span><span class="err">onCmd</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">01</span><span class="err">;</span><span class="w">

            </span><span class="err">if(linkState</span><span class="w"> </span><span class="err">==</span><span class="w"> </span><span class="err">APP_BLE_STATE_CONNECTED)</span><span class="w">
                </span><span class="err">BLE_TRSPS_SendVendorCommand(conn_hdl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">8</span><span class="err">F</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">01</span><span class="p">,</span><span class="w"> </span><span class="err">&amp;onCmd);</span><span class="w">            
        </span><span class="p">}</span><span class="w">
        </span><span class="err">break;</span><span class="w">
        </span><span class="err">case</span><span class="w"> </span><span class="err">CMD_ZCL_OFF:</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="err">/*</span><span class="w"> </span><span class="err">ZCL</span><span class="w"> </span><span class="err">Command</span><span class="w"> </span><span class="err">Off</span><span class="w"> </span><span class="err">received</span><span class="w"> </span><span class="err">*/</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.zclEventData.addressing;</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.zclEventData.payloadLength;</span><span class="w">
            </span><span class="err">//Access</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">&gt;</span><span class="w"> </span><span class="err">event.eventData.zclEventData.payload;</span><span class="w">
            </span><span class="err">appSnprintf(</span><span class="s2">"Off</span><span class="se">\r\n</span><span class="s2">"</span><span class="err">);</span><span class="w">
            </span><span class="err">uint</span><span class="mi">8</span><span class="err">_t</span><span class="w"> </span><span class="err">offCmd;</span><span class="w">
            </span><span class="err">offCmd</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">00</span><span class="err">;</span><span class="w">

            </span><span class="err">if(linkState</span><span class="w"> </span><span class="err">==</span><span class="w"> </span><span class="err">APP_BLE_STATE_CONNECTED)</span><span class="w">
                </span><span class="err">BLE_TRSPS_SendVendorCommand(conn_hdl</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">8</span><span class="err">F</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">01</span><span class="p">,</span><span class="w"> </span><span class="err">&amp;offCmd);</span><span class="w">             
        </span><span class="p">}</span><span class="w">
        </span><span class="err">break;</span><span class="w">
</span></code></pre></div></div> <ul> <li>Add the include file needed for the above BLE API’s in <strong>app_zigbee_handler.c</strong></li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#include</span><span class="w"> </span><span class="s2">"app_ble_handler.h"</span><span class="w">
</span><span class="err">#include</span><span class="w"> </span><span class="s2">"ble_trsps.h"</span><span class="w">
</span></code></pre></div></div> <h4 id="2-send-data-over-zigbee-app_trsps_handlerc"> <a href="readme.html#2-send-data-over-zigbee-app_trsps_handlerc" aria-labelledby="2-send-data-over-zigbee-app_trsps_handlerc" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 2. Send data over ZIGBEE (app_trsps_handler.c) </h4> <ul> <li>When the On/Off single byte data is received from mobile app using Transparent service, change the global variable which holds the On/Off attribute value.</li> <li>On/Off attribute data is sent periodically at defined MAX interval to CI. When the On/Off attribute value is changed by BLE, an additional report will be sent at MIN report interval with the changed value. The reporting interval is configured in auto generated Zigbee middleware include file <strong>\firmware\src\config\default\zigbee\zigbee_device\devicetypes\light\include\lightOnOffCluster.h</strong> (unit in seconds)</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">/******************************************************************************</span><span class="w">
                    </span><span class="err">Definition(s)</span><span class="w"> </span><span class="err">section</span><span class="w">
</span><span class="err">******************************************************************************/</span><span class="w">
</span><span class="err">#define</span><span class="w"> </span><span class="err">ONOFF_VAL_MIN_REPORT_PERIOD</span><span class="w"> </span><span class="mi">30</span><span class="w">
</span><span class="err">#define</span><span class="w"> </span><span class="err">ONOFF_VAL_MAX_REPORT_PERIOD</span><span class="w"> </span><span class="mi">60</span><span class="w">
</span></code></pre></div></div> <ul> <li>When the non zero value is sent from mobile app using TRPS Ctrl pt characteristic, the LED is switched ON and for zero value LED is switched OFF in BLE_TRSPS_EVT_VENDOR_CMD event callback. Add the below code to update the On/Off attribute Value and to change <strong>RED LED</strong> Status. <strong>ZCL_ReportOnChangeIfNeeded()</strong> API is called to initiate the additional report at <strong>ONOFF_VAL_MIN_REPORT_PERIOD</strong> interval. <strong>lightOnOffClusterServerAttributes.onOff</strong> is the global variable defined in Zigbee middleware which holds the OnOFF attribute value.</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">void</span><span class="w"> </span><span class="err">APP_TrspsEvtHandler(BLE_TRSPS_Event_T</span><span class="w"> </span><span class="err">*p_event)</span><span class="w">
</span><span class="p">{</span><span class="w">
    </span><span class="err">switch(p_event-&gt;eventId)</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="err">case</span><span class="w"> </span><span class="err">BLE_TRSPS_EVT_VENDOR_CMD:</span><span class="w">
        </span><span class="p">{</span><span class="w">
            </span><span class="err">/*</span><span class="w"> </span><span class="err">TODO:</span><span class="w"> </span><span class="err">implement</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">application</span><span class="w"> </span><span class="err">code.*/</span><span class="w">
            </span><span class="err">/*</span><span class="w"> </span><span class="err">TODO:</span><span class="w"> </span><span class="err">implement</span><span class="w"> </span><span class="err">your</span><span class="w"> </span><span class="err">application</span><span class="w"> </span><span class="err">code.*/</span><span class="w">
            </span><span class="err">if(p_event-&gt;eventField.onVendorCmd.length)</span><span class="w">
            </span><span class="p">{</span><span class="w">                 
                </span><span class="err">if(p_event-&gt;eventField.onVendorCmd.p_payLoad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="err">)</span><span class="w">
                </span><span class="p">{</span><span class="w">    
                    </span><span class="err">lightOnOffClusterServerAttributes.onOff.value</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">1</span><span class="err">;</span><span class="w">
                    </span><span class="err">RED_LED_Set();</span><span class="w">
                    </span><span class="err">appSnprintf(</span><span class="s2">"[BLE} On Command</span><span class="se">\n\r</span><span class="s2">"</span><span class="err">);</span><span class="w">                    
                </span><span class="p">}</span><span class="w">    
                </span><span class="err">else</span><span class="w">
                </span><span class="p">{</span><span class="w">    
                    </span><span class="err">lightOnOffClusterServerAttributes.onOff.value</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="mi">0</span><span class="err">;</span><span class="w">
                    </span><span class="err">RED_LED_Clear();</span><span class="w">
                    </span><span class="err">appSnprintf(</span><span class="s2">"[BLE} Off Command</span><span class="se">\n\r</span><span class="s2">"</span><span class="err">);</span><span class="w">                    
                </span><span class="p">}</span><span class="w">                   
                </span><span class="err">ZCL_ReportOnChangeIfNeeded(&amp;lightOnOffClusterServerAttributes.onOff);</span><span class="w">
            </span><span class="p">}</span><span class="w">     
        </span><span class="p">}</span><span class="w">
        </span><span class="err">break;</span><span class="w">
</span></code></pre></div></div> <ul> <li>Add the include file needed for the above ZIGBEE API and GPIO in <strong>app_trsps_handler.c</strong></li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">#include</span><span class="w"> </span><span class="err">&lt;app_zigbee/zigbee_console/console.h&gt;</span><span class="w">
</span><span class="err">#include</span><span class="w"> </span><span class="err">&lt;zigbee_device/devicetypes/light/include/lightOnOffCluster.h&gt;</span><span class="w">
</span><span class="err">#include</span><span class="w"> </span><span class="s2">"peripheral/gpio/plib_gpio.h"</span><span class="w">
</span></code></pre></div></div> <p><strong>Note:</strong> The sample project with all the above code changes is available in <a href="firmware/index.html"> ble_zigbee_basic </a> for your reference.</p> <hr /> <h2 id="programming-the-application-using-mplabx-ide"> <a href="readme.html#programming-the-application-using-mplabx-ide" aria-labelledby="programming-the-application-using-mplabx-ide" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Programming the Application using MPLABX IDE </h2> <ul> <li>Build the project after doing all the above changes and program on Curiosity board</li> </ul> <p><img src="assets/program.png" alt="" /></p> <ul> <li>Program the combined interface <a href="../../zigbee/zigbee_combined_interface/precompiled_hex/index.html"> hex </a> image on another curiosity board for Zigbee gateway by following <a href="http://10.12.73.139:4000/wireless/apps/multiprotocol/ble_zigbee_basic/tasks_1">below steps</a>.</li> </ul> <hr /> <p><a name="tasks_1"> </a></p> <h2 id="programming-the-precompiled-hex-file-using-mplabx-ipe"> <a href="readme.html#programming-the-precompiled-hex-file-using-mplabx-ipe" aria-labelledby="programming-the-precompiled-hex-file-using-mplabx-ipe" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Programming the precompiled hex file using MPLABX IPE </h2> <ol> <li> <p>Precompiled Hex file is located <a href="precompiled_hex/index.html"> here </a></p> </li> <li> <p>Follow the steps mentioned <a href="https://microchipdeveloper.com/ipe:programming-device">here</a></p> </li> <li> <p>Program the combined interface <a href="../../zigbee/zigbee_combined_interface/precompiled_hex/index.html"> hex </a> image on another curiosity board for Zigbee gateway by following same procedure.</p> </li> </ol> <p><strong>Caution:</strong> Users should choose the correct Device and Tool information</p> <hr /> <h2 id="testing"> <a href="readme.html#testing" aria-labelledby="testing" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Testing </h2> <p>This section assumes that user has already programmed multiprotocol Application Example and combined interface example on 2 WBZ451 Curiosity boards</p> <p><strong>Demo Experience when using a Smartphone (MBD App) as Central Device</strong></p> <ol> <li> <p>Reset the Combined Interface programmed WBZ451 Curiosity board, Open Terminal emulator like Tera Term, select the right COM port@ (Speed: 115200, Data: 8-bit, Parity: none, stop bits: 1 bit, Flow control: none, enable CR+LF for RX, TX in Terminal setup).</p> </li> <li> <p>send command: <em>resetToFN</em> and look for the below logs for successful zigbee network formation on CI</p> </li> </ol> <div style="text-align:center"><img src="assets/CI_1.png" /></div> <ol> <li>Reset combo device and send command: <em>resetToFN</em>. Look for combo device joined with combined Interface. The on/off light cluster search and binding between 2 devices is successful, and combo device on/off light attributes reports are seen in CI. This would take about 180sec.</li> </ol> <div style="text-align:center"><img src="assets/success.png" /></div> <ol> <li>Open Microchip Bluetooth Data (MBD) App on your smartphone, Search and select the advertisement with Device Name “Combo”. Connect with the combo device.</li> </ol> <div style="text-align:center"><img src="assets/mbd.gif" /></div> <p>&lt;/br&gt;</p> <ol> <li>Enable Notify/Indicate to receive data from combo device</li> </ol> <p align="left"> <img src="assets/6.jpg" width="250" height="500" /> </p> <ol> <li>Write <strong>8F01</strong> to switch on RED LED and look for on/off attribute value changing to 0x01 in CI, and also RED LED is getting ON. Similarly write <em>*8F00</em> to switch off RED LED and look for attribute value changing to 0x00 in CI. As mentioned previously, it would take MIN report interval for the changed report value to appear in CI.</li> </ol> <p align="left"> <img src="assets/8.jpg" width="250" height="500" /> <img src="assets/9.jpg" width="250" height="500" /> </p> <div style="text-align:center"><img src="assets/command.png" /></div> <p>&lt;/br&gt;</p> <ol> <li>By sending on/off command from CI the RED LED can be switched On/Off. The value can be seen in MBD app as well. <ul> <li>The network address of the combo device is needed to send light control commands to combo device from CI. This network address can be got from Combined interface console log while joining was done.</li> </ul> </li> </ol> <div style="text-align:center"><img src="assets/na.png" /></div> <p>&lt;/br&gt;</p> <ul> <li>Another way to get the network address from combo device is executing the below command in combo light side.</li> </ul> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">        </span><span class="err">Command:</span><span class="w"> </span><span class="err">getNetworkAddress</span><span class="w">
        </span><span class="err">Response:</span><span class="w"> </span><span class="mi">9</span><span class="err">bfa</span><span class="w">
</span></code></pre></div></div> <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">On/off</span><span class="w"> </span><span class="err">command:</span><span class="w">
           </span><span class="err">onOff</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">9</span><span class="err">bfa</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">20</span><span class="w"> </span><span class="err">-on</span><span class="w">

           </span><span class="err">onOff</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">0</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">9</span><span class="err">bfa</span><span class="w"> </span><span class="mi">0</span><span class="err">x</span><span class="mi">20</span><span class="w"> </span><span class="err">-off</span><span class="w">
</span></code></pre></div></div> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  0x20 is zigbee end point number used for light can be taken from MHC configurator.
</code></pre></div></div> <div style="text-align:center"><img src="assets/ep.png" /></div> <p>&lt;/br&gt;</p> <div style="text-align:center"><img src="assets/command.png" /></div> <p>&lt;/br&gt;</p> <p align="left"> <img src="assets/10.jpg" width="250" height="500" /> <img src="assets/7.jpg" width="250" height="500" /> </p> <hr /> <h2 id="where-to-go-from-here"> <a href="readme.html#where-to-go-from-here" aria-labelledby="where-to-go-from-here" class="anchor-heading"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Where to go from here </h2> <ul> <li><a href="../ble_zigbee_light_prov/readme.html">Advanced Multiprotocol Application with Zigbee Provisioning over BLE</a> by following the similar implementation. The guide also explains the wrapper protocol written on top of BLE Transparent service for BLE provisioning and light control. The on board RGB colour is controlled in this example, which can be referenced for PWM functionality.</li> </ul> <hr> <footer> <p class="text-small text-grey-dk-000 mb-0"><img src='https://raw.githubusercontent.com/wiki/Microchip-MPLAB-Harmony/Microchip-MPLAB-Harmony.github.io/images/microchip_logo.png' /><br />Copyright &copy; 2020 Microchip Technology.</p> <!-- <p class="text-small text-grey-dk-000 mb-0"><img src='http://10.12.73.139:4000/wireless/assets/images/vendor/microchip_logo.png' /><br /> Copyright &copy; 2021 Microchip Technology.</p> --> </footer> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
